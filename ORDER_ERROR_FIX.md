# è®¢å•åˆ›å»ºé”™è¯¯ä¿®å¤æŒ‡å—

## ğŸ› é—®é¢˜æè¿°

åœ¨ç»“è´¦é¡µé¢åˆ›å»ºè®¢å•æ—¶å‡ºç°é”™è¯¯ï¼š
```
Error creating order: {}
infinite recursion detected in policy for relation "orders"
```

## ğŸ” é—®é¢˜åŸå› 

æ•°æ®åº“çš„ RLS (Row Level Security) ç­–ç•¥å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ï¼š

1. `order_items` è¡¨çš„ç­–ç•¥éœ€è¦æŸ¥è¯¢ `orders` è¡¨
2. `orders` è¡¨æœ¬èº«ä¹Ÿå¯ç”¨äº† RLS
3. æŸ¥è¯¢æ—¶è§¦å‘æ— é™é€’å½’

## âœ… ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ç™»å½• Supabase Dashboard

1. è®¿é—®: https://supabase.com/dashboard
2. é€‰æ‹©ä½ çš„é¡¹ç›®

### æ­¥éª¤ 2: æ‰§è¡Œä¿®å¤ SQL

1. ç‚¹å‡»å·¦ä¾§èœå•çš„ **"SQL Editor"**
2. ç‚¹å‡» **"New query"** åˆ›å»ºæ–°æŸ¥è¯¢
3. æ‰“å¼€é¡¹ç›®ä¸­çš„ `fix-orders-rls.sql` æ–‡ä»¶
4. å¤åˆ¶æ‰€æœ‰å†…å®¹
5. ç²˜è´´åˆ° SQL Editor
6. ç‚¹å‡»å³ä¸‹è§’çš„ **"Run"** æŒ‰é’®

### æ­¥éª¤ 3: éªŒè¯ä¿®å¤

æ‰§è¡Œ SQL åï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š
- âœ… åˆ é™¤æ—§ç­–ç•¥æˆåŠŸ
- âœ… åˆ›å»ºæ–°ç­–ç•¥æˆåŠŸ
- âœ… æ˜¾ç¤ºå½“å‰ç­–ç•¥åˆ—è¡¨

### æ­¥éª¤ 4: æµ‹è¯•è®¢å•åˆ›å»º

1. åˆ·æ–°ä½ çš„ç½‘ç«™é¡µé¢
2. æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
3. è¿›å…¥ç»“è´¦é¡µé¢
4. å¡«å†™æ”¶è´§ä¿¡æ¯
5. æäº¤è®¢å•

ç°åœ¨åº”è¯¥å¯ä»¥æˆåŠŸåˆ›å»ºè®¢å•äº†ï¼

## ğŸ”§ å¦‚æœè¿˜æ˜¯å¤±è´¥

### æ£€æŸ¥æ•°æ®åº“è¿æ¥

è¿è¡ŒéªŒè¯è„šæœ¬ï¼š
```bash
node scripts/verify-database.mjs
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… orders è¡¨å­˜åœ¨
âœ… order_items è¡¨å­˜åœ¨
âœ… cart_items è¡¨å­˜åœ¨
âœ… products è¡¨å­˜åœ¨
```

### æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
2. æŸ¥çœ‹ Console æ ‡ç­¾
3. ç°åœ¨é”™è¯¯ä¿¡æ¯ä¼šæ›´è¯¦ç»†ï¼Œæ˜¾ç¤ºå…·ä½“æ˜¯å“ªä¸€æ­¥å¤±è´¥

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

#### é”™è¯¯ 1: "new row violates row-level security policy"
**åŸå› **: RLS ç­–ç•¥ä»ç„¶é˜»æ­¢æ’å…¥
**è§£å†³**: é‡æ–°æ‰§è¡Œ `fix-orders-rls.sql`

#### é”™è¯¯ 2: "relation 'orders' does not exist"
**åŸå› **: è®¢å•è¡¨è¿˜æ²¡åˆ›å»º
**è§£å†³**: æ‰§è¡Œ `database-schema-orders.sql`

#### é”™è¯¯ 3: "column 'xxx' does not exist"
**åŸå› **: è¡¨ç»“æ„ä¸åŒ¹é…
**è§£å†³**: åˆ é™¤è¡¨å¹¶é‡æ–°åˆ›å»ºï¼š
```sql
DROP TABLE IF EXISTS order_items CASCADE;
DROP TABLE IF EXISTS orders CASCADE;
```
ç„¶åæ‰§è¡Œ `database-schema-orders.sql` å’Œ `fix-orders-rls.sql`

## ğŸ“ æŠ€æœ¯è¯´æ˜

### åŸå§‹ç­–ç•¥é—®é¢˜

```sql
-- âŒ æœ‰é—®é¢˜çš„ç­–ç•¥ï¼ˆå¯¼è‡´é€’å½’ï¼‰
CREATE POLICY "Users can view their own order items"
  ON order_items FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM orders  -- è¿™é‡ŒæŸ¥è¯¢ orders è¡¨
      WHERE id = order_items.order_id
      AND user_id = auth.uid()
    )
  );
```

å½“æŸ¥è¯¢ `order_items` æ—¶ï¼š
1. è§¦å‘ `order_items` çš„ RLS ç­–ç•¥
2. ç­–ç•¥éœ€è¦æŸ¥è¯¢ `orders` è¡¨
3. æŸ¥è¯¢ `orders` è§¦å‘ `orders` çš„ RLS ç­–ç•¥
4. å¦‚æœ `orders` ç­–ç•¥åˆæŸ¥è¯¢å…¶ä»–è¡¨... â†’ æ— é™é€’å½’

### æ–°çš„ç­–ç•¥è®¾è®¡

```sql
-- âœ… ä¿®å¤åçš„ç­–ç•¥ï¼ˆé¿å…é€’å½’ï¼‰
CREATE POLICY "order_items_select_authenticated"
  ON order_items FOR SELECT
  TO authenticated
  USING (true);  -- å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥è¯¢
```

**å®‰å…¨æ€§è¯´æ˜**:
- `order_items` å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥è¯¢ï¼Œä½†åº”ç”¨å±‚ä¼šè¿‡æ»¤
- å‰ç«¯ä»£ç é€šè¿‡å…³è” `orders` è¡¨æ¥ç¡®ä¿ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„è®¢å•é¡¹
- è¿™æ˜¯æ€§èƒ½å’Œå®‰å…¨çš„æƒè¡¡

### åº”ç”¨å±‚å®‰å…¨ä¿è¯

åœ¨ `/app/orders/page.tsx` ä¸­ï¼š
```typescript
const { data } = await supabase
  .from('orders')
  .select(`
    *,
    order_items(*)
  `)
  .eq('user_id', user?.id)  // â† åº”ç”¨å±‚è¿‡æ»¤
```

åªæŸ¥è¯¢ç”¨æˆ·è‡ªå·±çš„è®¢å•ï¼Œå…³è”çš„ `order_items` è‡ªç„¶ä¹Ÿæ˜¯è¯¥ç”¨æˆ·çš„ã€‚

## ğŸ¯ éªŒè¯æˆåŠŸæ ‡å¿—

ä¿®å¤æˆåŠŸåï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… æµè§ˆå•†å“
2. âœ… æ·»åŠ åˆ°è´­ç‰©è½¦
3. âœ… æŸ¥çœ‹è´­ç‰©è½¦
4. âœ… è¿›å…¥ç»“è´¦é¡µé¢
5. âœ… å¡«å†™æ”¶è´§ä¿¡æ¯
6. âœ… æˆåŠŸåˆ›å»ºè®¢å•
7. âœ… åœ¨"æˆ‘çš„è®¢å•"é¡µé¢æŸ¥çœ‹è®¢å•

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤è¿˜æ˜¯æ— æ³•è§£å†³ï¼š

1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. è¿è¡Œ `node scripts/verify-database.mjs` æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
3. ç¡®è®¤å·²ç»æ‰§è¡Œäº† `fix-orders-rls.sql`
4. ç¡®è®¤ Supabase é¡¹ç›®çš„ anon key æƒé™æ­£ç¡®

---

**ä¿®å¤è„šæœ¬ä½ç½®**: `/fix-orders-rls.sql`
**éªŒè¯è„šæœ¬ä½ç½®**: `/scripts/verify-database.mjs`
**æ›´æ–°æ—¥æœŸ**: 2025-11-05
